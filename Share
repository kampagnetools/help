<script type="text/javascript">
(function () {
  try {
    var dl = window.dataLayer = window.dataLayer || [];

    var fireOnce = function (formId) {
      var key = 'gf_submitted_' + (formId || 'unknown');
      if (sessionStorage.getItem(key) === 'done') return;
      sessionStorage.setItem(key, 'done');
      dl.push({ event: 'form_submit_once', form_id: String(formId || '') });
    };

    // --- A) AJAX: affyr når bekræftelsen er vist ---
    if (window.jQuery && window.jQuery(document).on) {
      window.jQuery(document).on('gform_confirmation_loaded', function (e, formId) {
        fireOnce(formId);
      });
    }
    document.addEventListener('gform_confirmation_loaded', function (e) {
      var formId = '';
      if (e && e.detail && e.detail.formId) formId = e.detail.formId;
      fireOnce(formId);
    }, true);

    // --- B) Non-AJAX: markér pending ved klik på submit-knap ---
    document.addEventListener('click', function (ev) {
      var t = ev.target || {};
      var id = t.id || '';
      var m = id.match(/^gform_submit_button_(\d+)$/);
      if (m) {
        sessionStorage.setItem('gf_pending_' + m[1], '1');
      }
    }, true);

    var isConfirmationDomPresent = function () {
      var nodes = document.querySelectorAll(
        '[id^="gform_confirmation_wrapper_"], [id^="gform_confirmation_message_"], .gform_confirmation_message'
      );
      return nodes && nodes.length > 0;
    };

    var hasValidationErrors = function (formId) {
      var err = document.querySelector('.gform_validation_errors, .validation_error');
      return !!err;
    };

    var checkNonAjaxConfirmation = function () {
      if (!isConfirmationDomPresent()) return;
      var wrap = document.querySelector('[id^="gform_confirmation_wrapper_"]');
      var formId = '';
      if (wrap && wrap.id) {
        var m = wrap.id.match(/(\d+)$/);
        if (m) formId = m[1];
      }
      if (formId && sessionStorage.getItem('gf_pending_' + formId) === '1') {
        if (!hasValidationErrors(formId)) {
          sessionStorage.removeItem('gf_pending_' + formId);
          fireOnce(formId);
        }
      } else if (!formId) {
        fireOnce('');
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkNonAjaxConfirmation);
    } else {
      checkNonAjaxConfirmation();
    }
  } catch (e) {}
})();
</script>
